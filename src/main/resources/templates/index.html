<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Todo List</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        body { font-family: system-ui, Arial, sans-serif; margin: 24px; }
        h1 { margin-bottom: 12px; }
        form { display: flex; gap: 8px; margin-bottom: 16px; }
        input[type="text"] { flex: 1; padding: 8px; }
        button { padding: 8px 12px; cursor: pointer; }
        ul { list-style: none; padding: 0; }
        li { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #eee; }
        .empty { color: #777; }
        .right { display: flex; gap: 6px; }
        .edit-form { display: flex; gap: 6px; align-items: center; flex: 1; }
        .edit-input { flex: 1; padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; }
        .save-btn { background-color: #28a745; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; }
        .cancel-btn { background-color: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; }
        .save-btn:hover { background-color: #218838; }
        .cancel-btn:hover { background-color: #c82333; }
        .todo-item { display: flex; align-items: center; gap: 8px; }
        .todo-checkbox { margin-right: 8px; }
        .todo-content.completed { text-decoration: line-through; color: #666; }
    </style>
</head>
<body>
<h1>Todo List</h1>

<form id="add-form">
    <input id="content-input" type="text" placeholder="할 일을 입력하세요" required />
    <button type="submit">추가</button>
</form>

<ul id="todo-list"></ul>
<p id="empty-text" class="empty" style="display:none;">할 일이 없습니다.</p>

<script>
    const $list = document.getElementById('todo-list');
    const $empty = document.getElementById('empty-text');
    const $form = document.getElementById('add-form');
    const $input = document.getElementById('content-input');

    async function fetchTodos() {
        const res = await fetch('/api/todos');
        if (!res.ok) { alert('목록을 불러오지 못했습니다.'); return; }
        renderList(await res.json());
    }

    function renderList(items) {
        $list.innerHTML = '';
        if (!items || items.length === 0) { $empty.style.display = 'block'; return; }
        $empty.style.display = 'none';
        for (const item of items) {
            const li = document.createElement('li');
            li.id = `todo-${item.id}`;
            
            const todoItem = document.createElement('div');
            todoItem.className = 'todo-item';
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'todo-checkbox';
            checkbox.checked = item.done;
            checkbox.onchange = () => toggleDone(item.id, checkbox.checked);
            
            const left = document.createElement('span');
            left.className = `todo-content ${item.done ? 'completed' : ''}`;
            left.textContent = `${item.id}. ${item.content}`;

            const right = document.createElement('span');
            right.className = 'right';

            const editBtn = document.createElement('button');
            editBtn.textContent = '수정';
            editBtn.onclick = () => startEdit(item.id, item.content);

            const delBtn = document.createElement('button');
            delBtn.textContent = '삭제';
            delBtn.onclick = () => deleteTodo(item.id);

            right.appendChild(editBtn);
            right.appendChild(delBtn);
            
            todoItem.appendChild(checkbox);
            todoItem.appendChild(left);
            li.appendChild(todoItem);
            li.appendChild(right);
            $list.appendChild(li);
        }
    }

    async function addTodo(content) {
        const res = await fetch('/api/todo', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content })
        });
        if (res.status === 201) { $input.value=''; fetchTodos(); }
        else { alert('추가 실패'); }
    }

    function startEdit(id, currentContent) {
        const li = document.getElementById(`todo-${id}`);
        const contentSpan = li.querySelector('.todo-content');
        const rightSpan = li.querySelector('.right');
        
        // 수정 모드로 변경
        const editForm = document.createElement('div');
        editForm.className = 'edit-form';
        editForm.innerHTML = `
            <input type="text" value="${currentContent}" class="edit-input" />
            <button onclick="saveEdit(${id})" class="save-btn">저장</button>
            <button onclick="cancelEdit(${id}, '${currentContent}')" class="cancel-btn">취소</button>
        `;
        
        // 기존 내용 숨기고 수정 폼 표시
        contentSpan.style.display = 'none';
        rightSpan.style.display = 'none';
        li.appendChild(editForm);
    }

    async function saveEdit(id) {
        const li = document.getElementById(`todo-${id}`);
        const input = li.querySelector('.edit-input');
        const newContent = input.value.trim();
        
        if (!newContent) {
            alert('내용을 입력해주세요.');
            return;
        }
        
        try {
            const res = await fetch(`/api/todo/${id}/content`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content: newContent })
            });
            
            if (res.status === 200) {
                // 수정 성공 시 목록 새로고침
                fetchTodos();
            } else {
                alert('수정에 실패했습니다.');
            }
        } catch (error) {
            alert('수정 중 오류가 발생했습니다.');
        }
    }

    function cancelEdit(id, originalContent) {
        const li = document.getElementById(`todo-${id}`);
        const contentSpan = li.querySelector('.todo-content');
        const rightSpan = li.querySelector('.right');
        const editForm = li.querySelector('.edit-form');
        
        // 원래 상태로 복원
        contentSpan.style.display = 'block';
        rightSpan.style.display = 'block';
        li.removeChild(editForm);
    }

    async function toggleDone(id, done) {
        try {
            const res = await fetch(`/api/todo/${id}/done`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ done })
            });
            
            if (res.status === 200) {
                // 체크박스 상태 업데이트
                const li = document.getElementById(`todo-${id}`);
                const contentSpan = li.querySelector('.todo-content');
                if (done) {
                    contentSpan.classList.add('completed');
                } else {
                    contentSpan.classList.remove('completed');
                }
            } else {
                alert('상태 변경에 실패했습니다.');
                // 체크박스 상태 되돌리기
                const checkbox = document.querySelector(`#todo-${id} .todo-checkbox`);
                checkbox.checked = !done;
            }
        } catch (error) {
            alert('상태 변경 중 오류가 발생했습니다.');
            // 체크박스 상태 되돌리기
            const checkbox = document.querySelector(`#todo-${id} .todo-checkbox`);
            checkbox.checked = !done;
        }
    }

    async function deleteTodo(id) {
        if (!confirm('삭제하시겠습니까?')) return;
        const res = await fetch(`/api/todo/${id}`, { method: 'DELETE' });
        if (res.status === 200) fetchTodos(); else alert('삭제 실패');
    }

    $form.addEventListener('submit', (e) => {
        e.preventDefault();
        const content = $input.value.trim();
        if (!content) return;
        addTodo(content);
    });

    fetchTodos();
</script>
</body>
</html>